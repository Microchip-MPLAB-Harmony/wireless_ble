<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Using the BLE Software" />
<meta name="DC.relation" scheme="URI" content="GUID-222749FE-01C5-43B6-A5C7-CD82B3FC7F5F.html" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="using-the-ble-software" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<title>Using the BLE Software</title>
<meta name="Microsoft.Help.Id" content="GUID-C5EAF60E-9124-427C-A0F1-F2DBE662EA92-using-the-ble-software" />
<meta name="Microsoft.Help.TocParent" content="GUID-C5EAF60E-9124-427C-A0F1-F2DBE662EA92-GUID-222749FE-01C5-43B6-A5C7-CD82B3FC7F5F" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLAB Harmony wireless_ble Reference 1.0 03/2022" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
         
         function copyContent(content, button) {
         
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                     button.textContent = "Copy";
                     button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
               console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
         }
         
         function cpy(id, button) {
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            
            copyContent(content, button);
         }
         
         document.addEventListener("DOMContentLoaded", function(event) {
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.style.position = "relative";
               var copy = document.createElement("button");
               copy.textContent = "Copy";
               copy.setAttribute("class", "copy-code");
               
               var content = elem.textContent;
               
               copy.addEventListener("click", function(){
                  copyContent(content, copy);
               });
               
               elem.addEventListener("mouseenter", function(evt){
                  elem.prepend(copy);
               });
            });
            
            document.querySelectorAll(".codeblock").forEach(function(elem) {
               elem.addEventListener("mouseleave", function(evt){
                  document.querySelector(".copy-code").remove();
               });
            });
         });
         
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-9FB92A59-EC4A-4262-888E-E0B0651D0F34"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style><link rel="stylesheet" type="text/css" href="syntax-highlight.css" /></head>
<body id="using-the-ble-software">
<h1 class="title topictitle1" id="ariaid-title1">Using the BLE Software</h1><div class="body"><p class="p">Application shall be able to get the events from BLE Stack if the callback event is registered.
And it is strongly recommend application shall not handle the event directly.
Because timing is critical for BLE Stack, application shall not occupy the execution time before task switch.
Application shall generate a new message to handle the event within application task execution time.</p>
<p class="p">Example of handling event from BLE Stack:</p>
<pre class="pre codeblock c">
    <em class="hl-comment">//Create a new message and handler the event later</em>
    <strong class="hl-keyword">void</strong> <span class="hl-functions">APP_BleStackCb</span>(STACK_Event_T *p_stack)
    {
        STACK_Event_T stackEvent;
        APP_Msg_T   appMsg;
        APP_Msg_T   *p_appMsg;
    
        memcpy((uint8_t *)&amp;stackEvent, (uint8_t *)p_stack, <strong class="hl-keyword">sizeof</strong>(STACK_Event_T));
        stackEvent.p_event=OSAL_Malloc(p_stack-&gt;evtLen);
        <strong class="hl-keyword">if</strong>(stackEvent.p_event==NULL)
        {
            <strong class="hl-keyword">return</strong>;
        }
        memcpy(stackEvent.p_event, p_stack-&gt;p_event, p_stack-&gt;evtLen);
        stackEvent.p_event=stackEvent.p_event;
        ...
    
        appMsg.msgId=APP_MSG_BLE_STACK_EVT;
    
        ((STACK_Event_T *)appMsg.msgData)-&gt;groupId=p_stack-&gt;groupId;
        ((STACK_Event_T *)appMsg.msgData)-&gt;evtLen=p_stack-&gt;evtLen;
        ((STACK_Event_T *)appMsg.msgData)-&gt;p_event=stackEvent.p_event;
    
        p_appMsg = &amp;appMsg;
        OSAL_QUEUE_Send(&amp;appData.appQueue, p_appMsg, <span class="hl-number">0</span>);
    }
    
    <em class="hl-comment">//Handle the BLE Stack events</em>
    <strong class="hl-keyword">void</strong> APP_Tasks ( <strong class="hl-keyword">void</strong> )
    {
        APP_Msg_T    appMsg[<span class="hl-number">1</span>];
        APP_Msg_T   *p_appMsg;
        p_appMsg=appMsg;
    
        <em class="hl-comment">/* Check the application's current state. */</em>
        <strong class="hl-keyword">switch</strong> ( appData.state )
        {
            ...
            <strong class="hl-keyword">case</strong> APP_STATE_SERVICE_TASKS:
            {
                <strong class="hl-keyword">if</strong> (OSAL_QUEUE_Receive(&amp;appData.appQueue, &amp;appMsg, OSAL_WAIT_FOREVER))
                {
                    <strong class="hl-keyword">if</strong>(p_appMsg-&gt;msgId==APP_MSG_BLE_STACK_EVT)
                    {
                        APP_BleStackEvtHandler((STACK_Event_T *)p_appMsg-&gt;msgData);
                    }
                }
                <strong class="hl-keyword">break</strong>;
            }
        }
    }
}</pre><p class="p">All the group events of BLE Stack comes in one entry point.
Hence, application shall check the groupId to identify the group first when receiving the BLE Stack event.
And then check the eventId in each group.</p>
<p class="p">Example of handling the BLE Stack events:</p>
<pre class="pre codeblock c"><strong class="hl-keyword">void</strong> <span class="hl-functions">APP_BleStackEvtHandler</span>(STACK_Event_T *p_stackEvt)
{
    <strong class="hl-keyword">switch</strong> (p_stackEvt-&gt;groupId)
    {
        <strong class="hl-keyword">case</strong> STACK_GRP_BLE_GAP:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
        }
        <strong class="hl-keyword">break</strong>;
        
        <strong class="hl-keyword">case</strong> STACK_GRP_BLE_L2CAP:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
        }
        <strong class="hl-keyword">break</strong>;

        <strong class="hl-keyword">case</strong> STACK_GRP_BLE_SMP:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
        }
        <strong class="hl-keyword">break</strong>;

        <strong class="hl-keyword">case</strong> STACK_GRP_GATT:
        {
            <em class="hl-comment">/* TODO: implement your application code.*/</em>
        }
        <strong class="hl-keyword">break</strong>;

    } 
    OSAL_Free(p_stackEvt-&gt;p_event);
}</pre></div>
<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-222749FE-01C5-43B6-A5C7-CD82B3FC7F5F.html">BLE Software Specification</a></div>
</div>
</div></body>
</html>